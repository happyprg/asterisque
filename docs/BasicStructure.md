# Basic Structure

asterisque ではノードが通信を行う時に双方のノードでセッションが発生します。通信は双方のノードがセッション上でメッセージと呼ばれるデータ単位を交換することによって行われます。

## Message

**Message** は数バイトから数十キロバイトのバイナリで表現される asterisque 通信の基本的なデータ単位。1つのメッセージサイズは小規模なデバイスでも一度にメモリ上に乗せられるデータ量を想定し 65,535 バイトまでとしている。

asterisque で使用するメッセージは `Open`, `Close`, `Block`, `Control` の 4 種類である。以下にそれぞれのメッセージについて記述する。

### Open メッセージ

| field name | type    | size  | description |
|------------|---------|-------|-------------|
| pipeId     | UINT16  |     2 | |
| serviceId  | UTF8    | 0~255 | |
| functionId | UINT16  |     2 | |
| params     | OBJECT* |     * | |
| priority   | INT8    |     1 | default 0 |

Open メッセージはリモートノードに実装されている function (処理) を起動しセッション上にパイプを構築するために使用される。メッセージには function に特有のパラメータを含めることができる。

Open メッセージが受け入れられ function の処理が開始するとパイプが発生して通信端点の双方にキューが生成される。その呼び出しに関連するメッセージは全てそのキューに宛てられる。

同一のセッション内で複数のパイプが発生する。優先度を指定することでパイプ間でやりとりされるメッセージを調整することができる。

### Close メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| result     | OBJECT |    * | |
| abort      | ABORT  |    * | {code, message} |

Close メッセージはパイプを終了し通信相手にパイプ上で行われた処理の結果を返すために使用される。メッセージは成功した処理の結果か、失敗したエラー情報のどちらかを含むことができる。

Close メッセージの送受信によりセッション上のパイプは消滅する。

### Block メッセージ

| field name | type   | size | description |
|------------|--------|------|-------------|
| pipeId     | UINT16 |    2 | |
| payload    | UINT8* |    * | |
| loss       | UINT7  |    1 | default 0 |
| eof        | BIT1   |    1 |default 0 |

Block メッセージはセッション上に構築したパイプ上でのメッセージングや Blob 転送に使用される。

loss と eof はパックされ UINT8 に納めることができる。

### Control

| field name | type   | description |
|------------|--------|-------------|
| pipeId     | UINT16 | |
| code       | INT32  | |
| data       | UINT8* | |

Control メッセージはセッション開始時の状態同期やセッション終了などの制御に用いられる。

### 相互動作

単純な RPC を行うケースでは、リモート処理の起動、及び結果の取得は Open メッセージと Close メッセージの 1 往復で行われます (これは後述するパイプの生成と消滅と等価です)。往路の Open メッセージには実行するリモート処理のファンクション番号と実行パラメータ、優先度が付属します。また復路の Close メッセージは正常終了または異常終了の結果が付属します。これは一般的な RPC 実装での Request-Response 型メッセージングと同じモデルです。

Block メッセージは RPC 実行時の Open から Close までの間に呼び出し元と飛び出し先の処理でメッセージ交換を行うために使用されます。この Block メッセージを使用してローカル/リモート処理の間で非同期メッセージング、ストリーミングまたは BLOB 転送を行う事が出来ます。ローカル/リモート処理は 1 度の呼び出し中に任意個数の Block メッセージを送受信することができます。

Control メッセージは接続時の状態の同期や接続終了などセッション制御に関するインタラクションを行うためのメッセージです。

## State Management

asterisque は **Node** と呼ばれる抽象化されたネットワーク上の通信端点を定義するところから始まります。

ノードがリモートと接続すると双方向に **Session** が発生します。Session にはリモート呼び出しが可能な **Function** のセット及びアプリケーション状態を持つ **Service** が関連付けられています。

リモートの Function を呼び出す時、双方の Session にその処理の開始から終了まで **Pipe** が発生します。Pipe は Block 及び Close メッセージの宛先を示し、またそのためのキューを持ちます。単純な RPC 呼び出しのケースでは Pipe も短命で消滅するが、1 度の呼び出し内で継続的にメッセージパッシングなどを行うケースでは長い寿命を持つでしょう。

asterisque でのリモート処理は双方のセッションで Pipe を Open し、Pipe を通じて Block を交換し、Pipe を Close するというモデルです。

## Communication Implementation

